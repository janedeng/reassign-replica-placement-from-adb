# Reassign-replica-placement-from-adb

### This is not fully tested for production usage. Use with caution and carefully review the resulted output for any hot spots. 

This is a tool to reassign the preferred leaders to a list of Kafka brokers based on the replica placement proposed by Confluent Auto Data Balancer (ADB).

This is for reassigning the replica placement for MRC cluster. When using Confluent ADB tool to reassign partition, currently ADB distributes the preferred leaders across all regions. This may not be a desirable behavior when use cases require the preferred leaders to be deterministic. On the other hand, when a topic is created with a replica placement constraint, the preferred leaders are placed in the first rack of the replica placement constraint. You may want to simulate the same behavior of the topic creation.

This tool takes the proposed partition reassignment from ADB and the input of a list of preferred leaders. If the leaders in the current proposal are not in the preferred list, rearrange the assignment. 

If you use other tool to generate the partition reassigment json file, you can also use this tool to reassign preferred leaders. In general, the proposal generated by ADB is evenly distributed and good to use as the initial input before reassignment.  

For example: 

```
Original proposed replica list: [5, 2, 4, 8, 1, 6], observers = [1,6]
The preferred brokers to be leaders: [1, 2, 4]
Rearrange the replica assigment: loop by 4
5, 2, 4, 8,  [1,6]
2, 4, 8, 5,  [1,6]
2, 4, 8, 5,  [1,6]
2, 4, 5, 8,  [1,6]
The result list: [2, 4, 5, 8, 1, 6]
```

# Prerequisite:

Python 3.9 or above.

# Document:

```
usage: python reassign-partition-from-json.py [-h] -pr PREFER [PREFER ...] [-o OUTPUT] [-pt INDENT] -i INPUT

Options:
-pr <1 2 3 ..>           (Required) A list of integer for the preferred broker ids. 
-i <input json file>     (Required) The pre-generated replica placement json file.
-o <output json file>    The output replica placement json file. It will be print to ternimal if no output file is passed.
-pt <2>                  Pretty print the json file by adding indent, for example, indent=2. If no pretty print, the orginal format as the input file will be used.
```

# Demo

```

1. Create a test topic:

$. kafka-topics --create --bootstrap-server localhost:19091 --topic test --replication-factor 3 --partitions 25

2. Describe topic:

$ kafka-topics --describe --bootstrap-server localhost:19091 --topic test

Topic: test	TopicId: EXJXlu96SiqJITu9aWiiLQ	PartitionCount: 25	ReplicationFactor: 3	Configs: 
	Topic: test	Partition: 0	Leader: 6	Replicas: 6,1,2	Isr: 6,1,2	Offline: 
	Topic: test	Partition: 1	Leader: 2	Replicas: 2,6,8	Isr: 2,6,8	Offline: 
	Topic: test	Partition: 2	Leader: 8	Replicas: 8,2,4	Isr: 8,2,4	Offline: 
	Topic: test	Partition: 3	Leader: 4	Replicas: 4,8,5	Isr: 4,8,5	Offline: 
	Topic: test	Partition: 4	Leader: 5	Replicas: 5,4,1	Isr: 5,4,1	Offline: 
	Topic: test	Partition: 5	Leader: 1	Replicas: 1,5,6	Isr: 1,5,6	Offline: 
	Topic: test	Partition: 6	Leader: 6	Replicas: 6,2,8	Isr: 6,2,8	Offline: 
	Topic: test	Partition: 7	Leader: 2	Replicas: 2,8,4	Isr: 2,8,4	Offline: 
	Topic: test	Partition: 8	Leader: 8	Replicas: 8,4,5	Isr: 8,4,5	Offline: 
	Topic: test	Partition: 9	Leader: 4	Replicas: 4,5,1	Isr: 4,5,1	Offline: 
	Topic: test	Partition: 10	Leader: 5	Replicas: 5,1,6	Isr: 5,1,6	Offline: 
	Topic: test	Partition: 11	Leader: 1	Replicas: 1,6,2	Isr: 1,6,2	Offline: 
	Topic: test	Partition: 12	Leader: 6	Replicas: 6,4,5	Isr: 6,4,5	Offline: 
	Topic: test	Partition: 13	Leader: 2	Replicas: 2,5,1	Isr: 2,5,1	Offline: 
	Topic: test	Partition: 14	Leader: 8	Replicas: 8,1,6	Isr: 8,1,6	Offline: 
	Topic: test	Partition: 15	Leader: 4	Replicas: 4,6,2	Isr: 4,6,2	Offline: 
	Topic: test	Partition: 16	Leader: 5	Replicas: 5,2,8	Isr: 5,2,8	Offline: 
	Topic: test	Partition: 17	Leader: 1	Replicas: 1,8,4	Isr: 1,8,4	Offline: 
	Topic: test	Partition: 18	Leader: 6	Replicas: 6,1,2	Isr: 6,1,2	Offline: 
	Topic: test	Partition: 19	Leader: 2	Replicas: 2,6,8	Isr: 2,6,8	Offline: 
	Topic: test	Partition: 20	Leader: 8	Replicas: 8,2,4	Isr: 8,2,4	Offline: 
	Topic: test	Partition: 21	Leader: 4	Replicas: 4,8,5	Isr: 4,8,5	Offline: 
	Topic: test	Partition: 22	Leader: 5	Replicas: 5,4,1	Isr: 5,4,1	Offline: 
	Topic: test	Partition: 23	Leader: 1	Replicas: 1,5,6	Isr: 1,5,6	Offline: 
	Topic: test	Partition: 24	Leader: 6	Replicas: 6,4,5	Isr: 6,4,5	Offline:

3. Change topic config, attach replica placement json:

$ kafka-configs --bootstrap-server localhost:19091 --entity-name test  --entity-type topics --alter --replica-placement /etc/kafka/demo/placement-sync-op-mix-rack-7.3.json

4. Describe topic again:

$ kafka-topics --describe --bootstrap-server localhost:19091 --topic test

Topic: test	TopicId: EXJXlu96SiqJITu9aWiiLQ	PartitionCount: 25	ReplicationFactor: 3	Configs: confluent.placement.constraints={"observerPromotionPolicy":"under-min-isr","version":2,"replicas":[{"count":2,"constraints":{"rack":"west-1"}},{"count":2,"constraints":{"rack":"east-1"}}],"observers":[{"count":1,"constraints":{"rack":"west-1"}},{"count":1,"constraints":{"rack":"east-1"}}]}
	
  Topic: test	Partition: 0	Leader: 6	Replicas: 6,1,2	Isr: 6,1,2	Offline: 
	Topic: test	Partition: 1	Leader: 2	Replicas: 2,6,8	Isr: 2,6,8	Offline: 
	Topic: test	Partition: 2	Leader: 8	Replicas: 8,2,4	Isr: 8,2,4	Offline: 
	Topic: test	Partition: 3	Leader: 4	Replicas: 4,8,5	Isr: 4,8,5	Offline: 
	Topic: test	Partition: 4	Leader: 5	Replicas: 5,4,1	Isr: 5,4,1	Offline: 
	Topic: test	Partition: 5	Leader: 1	Replicas: 1,5,6	Isr: 1,5,6	Offline: 
	Topic: test	Partition: 6	Leader: 6	Replicas: 6,2,8	Isr: 6,2,8	Offline: 
	Topic: test	Partition: 7	Leader: 2	Replicas: 2,8,4	Isr: 2,8,4	Offline: 
	Topic: test	Partition: 8	Leader: 8	Replicas: 8,4,5	Isr: 8,4,5	Offline: 
	Topic: test	Partition: 9	Leader: 4	Replicas: 4,5,1	Isr: 4,5,1	Offline: 
	Topic: test	Partition: 10	Leader: 5	Replicas: 5,1,6	Isr: 5,1,6	Offline: 
	Topic: test	Partition: 11	Leader: 1	Replicas: 1,6,2	Isr: 1,6,2	Offline: 
	Topic: test	Partition: 12	Leader: 6	Replicas: 6,4,5	Isr: 6,4,5	Offline: 
	Topic: test	Partition: 13	Leader: 2	Replicas: 2,5,1	Isr: 2,5,1	Offline: 
	Topic: test	Partition: 14	Leader: 8	Replicas: 8,1,6	Isr: 8,1,6	Offline: 
	Topic: test	Partition: 15	Leader: 4	Replicas: 4,6,2	Isr: 4,6,2	Offline: 
	Topic: test	Partition: 16	Leader: 5	Replicas: 5,2,8	Isr: 5,2,8	Offline: 
	Topic: test	Partition: 17	Leader: 1	Replicas: 1,8,4	Isr: 1,8,4	Offline: 
	Topic: test	Partition: 18	Leader: 6	Replicas: 6,1,2	Isr: 6,1,2	Offline: 
	Topic: test	Partition: 19	Leader: 2	Replicas: 2,6,8	Isr: 2,6,8	Offline: 
	Topic: test	Partition: 20	Leader: 8	Replicas: 8,2,4	Isr: 8,2,4	Offline: 
	Topic: test	Partition: 21	Leader: 4	Replicas: 4,8,5	Isr: 4,8,5	Offline: 
	Topic: test	Partition: 22	Leader: 5	Replicas: 5,4,1	Isr: 5,4,1	Offline: 
	Topic: test	Partition: 23	Leader: 1	Replicas: 1,5,6	Isr: 1,5,6	Offline: 
	Topic: test	Partition: 24	Leader: 6	Replicas: 6,4,5	Isr: 6,4,5	Offline: 


5. Run ADB to propose a json file:

$ confluent-rebalancer proposed-assignment --bootstrap-server localhost:19091 --replica-placement-only --topics test > test_prop.json


Sample json from ADB:

{"version":1,"partitions":[{"topic":"test","partition":0,"observers":[4,8],"replicas":[6,1,2,5,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":1,"observers":[4,5],"replicas":[2,6,8,1,4,5],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":2,"observers":[1,6],"replicas":[8,2,4,5,1,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":3,"observers":[2,6],"replicas":[4,8,5,1,2,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":4,"observers":[2,8],"replicas":[5,4,1,6,2,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":5,"observers":[4,8],"replicas":[1,5,6,2,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":6,"observers":[4,5],"replicas":[6,8,2,1,4,5],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":7,"observers":[1,6],"replicas":[2,4,8,5,1,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":8,"observers":[2,6],"replicas":[8,5,4,1,2,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":9,"observers":[2,8],"replicas":[4,1,5,6,2,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":10,"observers":[4,8],"replicas":[5,6,1,2,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":11,"observers":[4,8],"replicas":[1,2,6,5,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":12,"observers":[2,8],"replicas":[6,5,4,1,2,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":13,"observers":[4,8],"replicas":[2,1,5,6,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":14,"observers":[4,5],"replicas":[8,6,1,2,4,5],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":15,"observers":[1,8],"replicas":[4,2,6,5,1,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":16,"observers":[4,6],"replicas":[5,8,2,1,4,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":17,"observers":[2,6],"replicas":[1,4,8,5,2,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":18,"observers":[4,8],"replicas":[6,1,2,5,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":19,"observers":[4,5],"replicas":[2,6,8,1,4,5],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":20,"observers":[1,6],"replicas":[8,2,4,5,1,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":21,"observers":[2,6],"replicas":[4,8,5,1,2,6],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":22,"observers":[2,8],"replicas":[5,4,1,6,2,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":23,"observers":[4,8],"replicas":[1,5,6,2,4,8],"log_dirs":["any","any","any","any","any","any"]},{"topic":"test","partition":24,"observers":[2,8],"replicas":[6,5,4,1,2,8],"log_dirs":["any","any","any","any","any","any"]}]}
                                        

6. Run reassign-partition-from-adb.py:

$ python ~/mycode/python/reassign-partition-from-adb/reassign-partition-from-json.py -i test_prop.json -pr 1 2 4 -pt 2 -o test_new.json | tee analysis

Content in test_new.json:

{
  "version": 1,
  "partitions": [
    {
      "topic": "test",
      "partition": 0,
      "observers": [
        4,
        8
      ],
      "replicas": [
        1,
        2,
        6,
        5,
        4,
        8
      ],
      "log_dirs": [
        "any",
        "any",
        "any",
        "any",
        "any",
        "any"
      ]
    },
    {
      "topic": "test",
      "partition": 1,
      "observers": [
        4,
        5
      ],
      "replicas": [
        2,
        1,
        6,
        8,
        4,
        ...... Omit lines


7. Run a bash script to analyze the partition placement and leader distribution. You could adjust the reassignment manually if there are any hot spots.

$ for i in {1..6}; do echo "==== the $i position ====="; printf "count  broker-id \n"; grep result: analysis | awk -F'[][]' '{print $2}' | awk -F "," -v a=$i '{print $a}' | sort | uniq -c; done 

==== the 1 position (preferred leaders) =====
count  broker-id 
   8 1
   8 2
   9 4
==== the 2 position =====
count  broker-id 
  13  1
   8  2
   4  4
==== the 3 position =====
count  broker-id 
   8  5
   9  6
   8  8
==== the 4 position =====
count  broker-id 
  13  5
   8  6
   4  8
==== the 5 position =====
count  broker-id 
   4  1
   9  2
  12  4
==== the 6 position =====
count  broker-id 
   4  5
   8  6
  13  8


8. Run kafka-reassign-partitions to apply the json file:

$ kafka-reassign-partitions --bootstrap-server localhost:19091 --execute --reassignment-json-file  /etc/kafka/demo/test_new.json

Current partition replica assignment
{"version":1,"partitions":[{"topic":"test","partition":0,"replicas":[6,1,2],"log_dirs":["any","any","any"]},{"topic":"test","partition":1,"replicas":[2,6,8],"log_dirs":["any","any","any"]},{"topic":"test","partition":2,"replicas":[8,2,4],"log_dirs":["any","any","any"]},{"topic":"test","partition":3,"replicas":[4,8,5],"log_dirs":["any","any","any"]},{"topic":"test","partition":4,"replicas":[5,4,1],"log_dirs":["any","any","any"]},{"topic":"test","partition":5,"replicas":[1,5,6],"log_dirs":["any","any","any"]},{"topic":"test","partition":6,"replicas":[6,2,8],"log_dirs":["any","any","any"]},{"topic":"test","partition":7,"replicas":[2,8,4],"log_dirs":["any","any","any"]},{"topic":"test","partition":8,"replicas":[8,4,5],"log_dirs":["any","any","any"]},{"topic":"test","partition":9,"replicas":[4,5,1],"log_dirs":["any","any","any"]},{"topic":"test","partition":10,"replicas":[5,1,6],"log_dirs":["any","any","any"]},{"topic":"test","partition":11,"replicas":[1,6,2],"log_dirs":["any","any","any"]},{"topic":"test","partition":12,"replicas":[6,4,5],"log_dirs":["any","any","any"]},{"topic":"test","partition":13,"replicas":[2,5,1],"log_dirs":["any","any","any"]},{"topic":"test","partition":14,"replicas":[8,1,6],"log_dirs":["any","any","any"]},{"topic":"test","partition":15,"replicas":[4,6,2],"log_dirs":["any","any","any"]},{"topic":"test","partition":16,"replicas":[5,2,8],"log_dirs":["any","any","any"]},{"topic":"test","partition":17,"replicas":[1,8,4],"log_dirs":["any","any","any"]},{"topic":"test","partition":18,"replicas":[6,1,2],"log_dirs":["any","any","any"]},{"topic":"test","partition":19,"replicas":[2,6,8],"log_dirs":["any","any","any"]},{"topic":"test","partition":20,"replicas":[8,2,4],"log_dirs":["any","any","any"]},{"topic":"test","partition":21,"replicas":[4,8,5],"log_dirs":["any","any","any"]},{"topic":"test","partition":22,"replicas":[5,4,1],"log_dirs":["any","any","any"]},{"topic":"test","partition":23,"replicas":[1,5,6],"log_dirs":["any","any","any"]},{"topic":"test","partition":24,"replicas":[6,4,5],"log_dirs":["any","any","any"]}]}
Save this to use as the --reassignment-json-file option during rollback
Successfully started partition reassignments for test-0,test-1,test-2,test-3,test-4,test-5,test-6,test-7,test-8,test-9,test-10,test-11,test-12,test-13,test-14,test-15,test-16,test-17,test-18,test-19,test-20,test-21,test-22,test-23,test-24


9. Describe test topic to see the result:

$ kafka-topics --describe --bootstrap-server localhost:19091 --topic test
Topic: test	TopicId: EXJXlu96SiqJITu9aWiiLQ	PartitionCount: 25	ReplicationFactor: 6	Configs: confluent.placement.constraints={"observerPromotionPolicy":"under-min-isr","version":2,"replicas":[{"count":2,"constraints":{"rack":"west-1"}},{"count":2,"constraints":{"rack":"east-1"}}],"observers":[{"count":1,"constraints":{"rack":"west-1"}},{"count":1,"constraints":{"rack":"east-1"}}]}
	Topic: test	Partition: 0	Leader: 1	Replicas: 1,2,6,5,4,8	Isr: 6,1,2,5	Offline: 	Observers: 4,8
	Topic: test	Partition: 1	Leader: 2	Replicas: 2,1,6,8,4,5	Isr: 2,6,8,1	Offline: 	Observers: 4,5
	Topic: test	Partition: 2	Leader: 2	Replicas: 2,4,8,5,1,6	Isr: 8,2,4,5	Offline: 	Observers: 1,6
	Topic: test	Partition: 3	Leader: 4	Replicas: 4,1,8,5,2,6	Isr: 4,8,5,1	Offline: 	Observers: 2,6
	Topic: test	Partition: 4	Leader: 4	Replicas: 4,1,5,6,2,8	Isr: 5,4,1,6	Offline: 	Observers: 2,8
	Topic: test	Partition: 5	Leader: 1	Replicas: 1,2,5,6,4,8	Isr: 1,5,6,2	Offline: 	Observers: 4,8
	Topic: test	Partition: 6	Leader: 2	Replicas: 2,1,6,8,4,5	Isr: 6,2,8,1	Offline: 	Observers: 4,5
	Topic: test	Partition: 7	Leader: 2	Replicas: 2,4,8,5,1,6	Isr: 2,8,4,5	Offline: 	Observers: 1,6
	Topic: test	Partition: 8	Leader: 4	Replicas: 4,1,8,5,2,6	Isr: 8,4,5,1	Offline: 	Observers: 2,6
	Topic: test	Partition: 9	Leader: 4	Replicas: 4,1,5,6,2,8	Isr: 4,5,1,6	Offline: 	Observers: 2,8
	Topic: test	Partition: 10	Leader: 1	Replicas: 1,2,5,6,4,8	Isr: 5,1,6,2	Offline: 	Observers: 4,8
	Topic: test	Partition: 11	Leader: 1	Replicas: 1,2,6,5,4,8	Isr: 1,6,2,5	Offline: 	Observers: 4,8
	Topic: test	Partition: 12	Leader: 4	Replicas: 4,1,6,5,2,8	Isr: 6,4,5,1	Offline: 	Observers: 2,8
	Topic: test	Partition: 13	Leader: 2	Replicas: 2,1,5,6,4,8	Isr: 2,5,1,6	Offline: 	Observers: 4,8
	Topic: test	Partition: 14	Leader: 1	Replicas: 1,2,8,6,4,5	Isr: 8,1,6,2	Offline: 	Observers: 4,5
	Topic: test	Partition: 15	Leader: 4	Replicas: 4,2,6,5,1,8	Isr: 4,6,2,5	Offline: 	Observers: 1,8
	Topic: test	Partition: 16	Leader: 2	Replicas: 2,1,5,8,4,6	Isr: 5,2,8,1	Offline: 	Observers: 4,6
	Topic: test	Partition: 17	Leader: 1	Replicas: 1,4,8,5,2,6	Isr: 1,8,4,5	Offline: 	Observers: 2,6
	Topic: test	Partition: 18	Leader: 1	Replicas: 1,2,6,5,4,8	Isr: 6,1,2,5	Offline: 	Observers: 4,8
	Topic: test	Partition: 19	Leader: 2	Replicas: 2,1,6,8,4,5	Isr: 2,6,8,1	Offline: 	Observers: 4,5
	Topic: test	Partition: 20	Leader: 2	Replicas: 2,4,8,5,1,6	Isr: 8,2,4,5	Offline: 	Observers: 1,6
	Topic: test	Partition: 21	Leader: 4	Replicas: 4,1,8,5,2,6	Isr: 4,8,5,1	Offline: 	Observers: 2,6
	Topic: test	Partition: 22	Leader: 4	Replicas: 4,1,5,6,2,8	Isr: 5,4,1,6	Offline: 	Observers: 2,8
	Topic: test	Partition: 23	Leader: 1	Replicas: 1,2,5,6,4,8	Isr: 1,5,6,2	Offline: 	Observers: 4,8
	Topic: test	Partition: 24	Leader: 4	Replicas: 4,1,6,5,2,8	Isr: 6,4,5,1	Offline: 	Observers: 2,8
```


